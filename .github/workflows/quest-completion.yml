name: Quest Completion

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  create-completion-pr:
    # Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€Œå®Œäº†ã—ã¾ã—ãŸã€ã€Œå®Œäº†ã€ã€Œdoneã€ãªã©ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œ
    if: |
      github.event.issue.state == 'open' &&
      contains(github.event.issue.labels.*.name, 'quest-in-progress') &&
      (
        contains(github.event.comment.body, 'å®Œäº†ã—ã¾ã—ãŸ') ||
        contains(github.event.comment.body, 'å®Œäº†') ||
        contains(github.event.comment.body, 'done') ||
        contains(github.event.comment.body, 'Done') ||
        contains(github.event.comment.body, 'DONE')
      )

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract quest information from issue
        id: extract-info
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body || '';
            const commenter = context.payload.comment.user.login;

            // Issueã®æœ¬æ–‡ã‹ã‚‰ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ©ãƒƒã‚°ã‚’æŠ½å‡º
            const questSlugMatch = issueBody.match(/ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ©ãƒƒã‚°[:\s]*(.+)/);

            const questSlug = questSlugMatch ? questSlugMatch[1].trim().replace(/`/g, '') : '';
            const username = commenter; // ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿è€…ã‚’å¸¸ã«ä½¿ç”¨

            if (!questSlug) {
              core.setFailed('ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ©ãƒƒã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
              return;
            }

            console.log('Quest Slug:', questSlug);
            console.log('Username:', username);
            console.log('Issue Number:', issue.number);

            core.setOutput('quest_slug', questSlug);
            core.setOutput('username', username);
            core.setOutput('issue_number', issue.number);
            core.setOutput('branch_name', `quest/${questSlug.replace(/\//g, '-')}/${username}`);

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch
        run: |
          git checkout -b ${{ steps.extract-info.outputs.branch_name }}

      - name: Update user progress
        id: update-progress
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const questSlug = '${{ steps.extract-info.outputs.quest_slug }}';
            const username = '${{ steps.extract-info.outputs.username }}';
            const progressPath = path.join('_data', 'progress.json');

            console.log('Quest slug:', questSlug);
            console.log('Username:', username);

            // ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ©ãƒƒã‚°ã‹ã‚‰dayç•ªå·ã‚’æŠ½å‡º (ä¾‹: "0/start" -> 0, "1/github-signup" -> 1)
            const dayMatch = questSlug.match(/^(\d+)\//);
            if (!dayMatch) {
              core.setFailed(`ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ©ãƒƒã‚°ã‹ã‚‰dayç•ªå·ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“: ${questSlug}`);
              return;
            }
            const completedDay = parseInt(dayMatch[1], 10);
            console.log('Completed day:', completedDay);

            // progress.jsonã‚’èª­ã¿è¾¼ã¿
            let progressData;
            if (fs.existsSync(progressPath)) {
              const progressContent = fs.readFileSync(progressPath, 'utf8');
              progressData = JSON.parse(progressContent);
            } else {
              progressData = { users: [] };
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
            let userProgress = progressData.users.find(u => u.githubUsername === username);
            let isNewUser = false;
            let isUpdated = false;

            if (!userProgress) {
              // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼
              userProgress = {
                githubUsername: username,
                currentDay: completedDay
              };
              progressData.users.push(userProgress);
              isNewUser = true;
              isUpdated = true;
              console.log(`New user ${username} added with day ${completedDay}`);
            } else {
              // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šå®Œäº†ã—ãŸdayãŒç¾åœ¨ã®currentDayã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿æ›´æ–°
              if (completedDay > userProgress.currentDay) {
                userProgress.currentDay = completedDay + 1;
                isUpdated = true;
                console.log(`Updated ${username} progress from ${userProgress.currentDay} to ${completedDay}`);
              } else if (completedDay === userProgress.currentDay) {
                console.log(`${username} has already completed day ${completedDay}`);
                isUpdated = false;
              } else {
                console.log(`${username} is already at day ${userProgress.currentDay}, completed day ${completedDay} is in the past`);
                isUpdated = false;
              }
            }

            if (isUpdated) {
              // progress.jsonã‚’ä¿å­˜ï¼ˆæ•´å½¢ã—ã¦ï¼‰
              fs.writeFileSync(progressPath, JSON.stringify(progressData, null, 2) + '\n');
              core.setOutput('updated', 'true');
              core.setOutput('progress_path', progressPath);
              core.setOutput('completed_day', completedDay.toString());
              core.setOutput('is_new_user', isNewUser.toString());
            } else {
              core.setOutput('updated', 'false');
            }

      - name: Commit changes
        if: steps.update-progress.outputs.updated == 'true'
        run: |
          git add ${{ steps.update-progress.outputs.progress_path }}
          git commit -m "âš”ï¸ quest: Update progress for ${{ steps.extract-info.outputs.username }} (Day ${{ steps.update-progress.outputs.completed_day }})

          Quest: ${{ steps.extract-info.outputs.quest_slug }}
          Closes #${{ steps.extract-info.outputs.issue_number }}"

      - name: Push branch
        if: steps.update-progress.outputs.updated == 'true'
        run: |
          git push origin ${{ steps.extract-info.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.update-progress.outputs.updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ‰ ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†: ${{ steps.extract-info.outputs.quest_slug }} - ${{ steps.extract-info.outputs.username }}`,
              head: '${{ steps.extract-info.outputs.branch_name }}',
              base: 'main',
              body: `## ğŸ¯ ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†

            ã“ã®PRã¯ã€ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ã®ç”³è«‹ã§ã™ã€‚

            ### ã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±
            - **ã‚¯ã‚¨ã‚¹ãƒˆ**: \`${{ steps.extract-info.outputs.quest_slug }}\`
            - **å®Œäº†è€…**: @${{ steps.extract-info.outputs.username }}
            - **å®Œäº†æ—¥**: Day ${{ steps.update-progress.outputs.completed_day }}
            - **é–¢é€£Issue**: #${{ steps.extract-info.outputs.issue_number }}

            ---

            ### ğŸ“ æå‡ºè€…ã¸

            ä»¥ä¸‹ã®æƒ…å ±ã‚’ã“ã®PRã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

            1. **æˆæœç‰©ãƒ»è¨¼æ‹ **
              - é–¢é€£URLï¼ˆè¨˜äº‹ã€ãƒªãƒã‚¸ãƒˆãƒªã€ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆãªã©ï¼‰
              - ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
              - ãã®ä»–ã®æˆæœç‰©

            2. **æŒ¯ã‚Šè¿”ã‚Š**
              - å­¦ã‚“ã ã“ã¨
              - è‹¦åŠ´ã—ãŸã“ã¨
              - æ¬¡ã«æŒ‘æˆ¦ã—ãŸã„ã“ã¨

            ---

            ### âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã¸

            æå‡ºç‰©ã‚’ç¢ºèªã—ã¦ã€æˆåŠŸæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹å ´åˆã¯Approveã—ã¦ãã ã•ã„ã€‚
            å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

            ---

            Closes #${{ steps.extract-info.outputs.issue_number }}`
                        });
                        
                        // PRã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                        await github.rest.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: pullRequest.number,
                          labels: ['quest-completion', 'needs-review']
                        });
                        
                        // å…ƒã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: ${{ steps.extract-info.outputs.issue_number }},
                          body: `ğŸ‰ ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ç”³è«‹ã®PRã‚’ä½œæˆã—ã¾ã—ãŸï¼

            PR: #${pullRequest.number}

            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
            1. PRã«æˆæœç‰©ï¼ˆURLã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãªã©ï¼‰ã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„
            2. æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜å…¥ã—ã¦ãã ã•ã„
            3. ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ï¼

            é ‘å¼µã‚Šã¾ã—ãŸã­ï¼ğŸ«âœ¨`
            });

            console.log('PR created:', pullRequest.html_url);

      - name: Comment if already completed
        if: steps.update-progress.outputs.updated == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.extract-info.outputs.issue_number }},
              body: `âš ï¸ @${{ steps.extract-info.outputs.username }} ã•ã‚“ã¯æ—¢ã«ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã¾ãŸã¯ãã‚Œä»¥é™ï¼‰ã‚’å®Œäº†ã—ã¦ã„ã¾ã™ã€‚

            é€²æ—çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š https://github.com/${{ github.repository }}/blob/main/_data/progress.json`
            });

  # PRæ‰¿èªæ™‚ã®å‡¦ç†
  quest-approved:
    # PRãŒApproveã•ã‚ŒãŸå ´åˆã«å®Ÿè¡Œ
    if: |
      github.event.review.state == 'approved' &&
      contains(github.event.pull_request.labels.*.name, 'quest-completion')

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Extract quest information from PR
        id: extract-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            const prTitle = pr.title || '';

            // PRã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ©ãƒƒã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æŠ½å‡º
            // ä¾‹: "ğŸ‰ [Quest Complete] level-0/start - @username"
            const titleMatch = prTitle.match(/\[Quest Complete\]\s+(.+?)\s+-\s+@(.+)/);

            if (!titleMatch) {
              core.setFailed('PRã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
              return;
            }

            const questSlug = titleMatch[1].trim();
            const username = titleMatch[2].trim();

            // PRãƒœãƒ‡ã‚£ã‹ã‚‰é–¢é€£Issueã‚’æŠ½å‡º
            const issueMatch = prBody.match(/Closes #(\d+)/);
            const issueNumber = issueMatch ? issueMatch[1] : null;

            console.log('Quest Slug:', questSlug);
            console.log('Username:', username);
            console.log('Issue Number:', issueNumber);
            console.log('PR Number:', pr.number);

            core.setOutput('quest_slug', questSlug);
            core.setOutput('username', username);
            core.setOutput('issue_number', issueNumber);
            core.setOutput('pr_number', pr.number);

      - name: Generate completion page URL
        id: generate-url
        run: |
          QUEST_SLUG="${{ steps.extract-info.outputs.quest_slug }}"
          USERNAME="${{ steps.extract-info.outputs.username }}"

          # BASE_URLã‚’ç’°å¢ƒã«å¿œã˜ã¦è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
          BASE_URL="https://blueberry-quest.vercel.app"

          # ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ©ãƒƒã‚°ã‚’URLãƒ‘ã‚¹ç”¨ã«å¤‰æ›ï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¯ãã®ã¾ã¾ï¼‰
          COMPLETION_URL="${BASE_URL}/quests/${QUEST_SLUG}/complete?username=${USERNAME}"

          echo "completion_url=${COMPLETION_URL}" >> $GITHUB_OUTPUT
          echo "Completion URL: ${COMPLETION_URL}"

      - name: Comment on PR with completion page
        uses: actions/github-script@v7
        with:
          script: |
            const completionUrl = '${{ steps.generate-url.outputs.completion_url }}';
            const username = '${{ steps.extract-info.outputs.username }}';
            const questSlug = '${{ steps.extract-info.outputs.quest_slug }}';

            const message = `# ğŸ‰ ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼

            @${username} ã•ã‚“ã€ã‚¯ã‚¨ã‚¹ãƒˆã€Œ${questSlug}ã€ã®å®Œäº†ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸï¼

            ## âœ¨ å®Œäº†ãƒšãƒ¼ã‚¸

            ã‚ãªãŸå°‚ç”¨ã®å®Œäº†ãƒšãƒ¼ã‚¸ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ï¼š

            ğŸ”— **[å®Œäº†ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹](${completionUrl})**

            å®Œäº†ãƒšãƒ¼ã‚¸ã§ã¯ä»¥ä¸‹ã®ã“ã¨ãŒã§ãã¾ã™ï¼š
            - ğŸŠ é”æˆã‚’ç¥ã†
            - ğŸ¦ X (Twitter) ã§ã‚·ã‚§ã‚¢ã™ã‚‹
            - ğŸ† æ¬¡ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¢ã™

            ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æ¬¡ã®å†’é™ºã‚‚æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ï¼ ğŸ«âœ¨`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });

            console.log('Posted completion page URL to PR');

      - name: Comment on related Issue
        if: steps.extract-info.outputs.issue_number != null
        uses: actions/github-script@v7
        with:
          script: |
            const completionUrl = '${{ steps.generate-url.outputs.completion_url }}';
            const username = '${{ steps.extract-info.outputs.username }}';
            const prNumber = '${{ steps.extract-info.outputs.pr_number }}';

            const message = `# ğŸ‰ ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸï¼

            @${username} ã•ã‚“ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼

            ã‚ãªãŸã®ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ç”³è«‹ï¼ˆPR #${prNumber}ï¼‰ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

            ## ğŸŠ å®Œäº†ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰

            ğŸ”— **[å®Œäº†ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹](${completionUrl})**

            å®Œäº†ãƒšãƒ¼ã‚¸ã§é”æˆã‚’ã‚·ã‚§ã‚¢ã—ã¾ã—ã‚‡ã†ï¼ğŸ«âœ¨`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.extract-info.outputs.issue_number }},
              body: message
            });

            console.log('Posted completion page URL to Issue');

      - name: Merge Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // PRã‚’ãƒãƒ¼ã‚¸
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                merge_method: 'squash',
                commit_title: `ğŸ‰ quest: Complete ${context.payload.pull_request.title}`,
                commit_message: `Approved by @${context.payload.review.user.login}`
              });
              
              console.log('PR merged successfully');
            } catch (error) {
              console.error('Failed to merge PR:', error);
              // ãƒãƒ¼ã‚¸ã«å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªä½“ã¯ç¶šè¡Œ
            }
