name: Quest Completion - Create PR

on:
  issue_comment:
    types: [created]

jobs:
  create-completion-pr:
    # Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€Œå®Œäº†ã—ã¾ã—ãŸã€ã€Œå®Œäº†ã€ã€Œdoneã€ãªã©ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œ
    if: |
      github.event.issue.state == 'open' &&
      contains(github.event.issue.labels.*.name, 'quest-in-progress') &&
      (
        contains(github.event.comment.body, 'å®Œäº†ã—ã¾ã—ãŸ') ||
        contains(github.event.comment.body, 'å®Œäº†') ||
        contains(github.event.comment.body, 'done') ||
        contains(github.event.comment.body, 'Done') ||
        contains(github.event.comment.body, 'DONE')
      )

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Extract quest information from issue
        id: extract-info
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body || '';
            const commenter = context.payload.comment.user.login;

            // Issueã®æœ¬æ–‡ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
            const questIdMatch = issueBody.match(/ã‚¯ã‚¨ã‚¹ãƒˆID[:\s]*(.+)/);
            const usernameMatch = issueBody.match(/GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å[:\s]*(.+)/);

            const questId = questIdMatch ? questIdMatch[1].trim().replace(/`/g, '') : '';
            const username = usernameMatch ? usernameMatch[1].trim().replace(/@/g, '') : commenter;

            if (!questId) {
              core.setFailed('ã‚¯ã‚¨ã‚¹ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
              return;
            }

            console.log('Quest ID:', questId);
            console.log('Username:', username);
            console.log('Issue Number:', issue.number);

            core.setOutput('quest_id', questId);
            core.setOutput('username', username);
            core.setOutput('issue_number', issue.number);
            core.setOutput('branch_name', `quest/${questId.replace(/\//g, '-')}/${username}`);

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch
        run: |
          git checkout -b ${{ steps.extract-info.outputs.branch_name }}

      - name: Add user to completers list
        id: update-quest
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const matter = require('gray-matter');

            const questId = '${{ steps.extract-info.outputs.quest_id }}';
            const username = '${{ steps.extract-info.outputs.username }}';
            const questPath = path.join('_data', `${questId}.md`);

            console.log('Quest file path:', questPath);

            if (!fs.existsSync(questPath)) {
              core.setFailed(`ã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${questPath}`);
              return;
            }

            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const fileContent = fs.readFileSync(questPath, 'utf8');
            const { data, content } = matter(fileContent);

            // completersã«è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
            if (!data.completers) {
              data.completers = [];
            }

            if (!data.completers.includes(username)) {
              data.completers.push(username);
              console.log(`Added ${username} to completers`);
              
              // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
              const newContent = matter.stringify(content, data);
              fs.writeFileSync(questPath, newContent);
              
              core.setOutput('updated', 'true');
              core.setOutput('quest_path', questPath);
            } else {
              console.log(`${username} is already in completers`);
              core.setOutput('updated', 'false');
            }

      - name: Commit changes
        if: steps.update-quest.outputs.updated == 'true'
        run: |
          git add ${{ steps.update-quest.outputs.quest_path }}
          git commit -m "feat: Add @${{ steps.extract-info.outputs.username }} to quest completers

          Quest ID: ${{ steps.extract-info.outputs.quest_id }}
          Closes #${{ steps.extract-info.outputs.issue_number }}"

      - name: Push branch
        if: steps.update-quest.outputs.updated == 'true'
        run: |
          git push origin ${{ steps.extract-info.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.update-quest.outputs.updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ‰ [Quest Complete] ${{ steps.extract-info.outputs.quest_id }} - @${{ steps.extract-info.outputs.username }}`,
              head: '${{ steps.extract-info.outputs.branch_name }}',
              base: 'main',
              body: `## ğŸ¯ ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†

            ã“ã®PRã¯ã€ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ã®ç”³è«‹ã§ã™ã€‚

            ### ã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±
            - **ã‚¯ã‚¨ã‚¹ãƒˆID**: \`${{ steps.extract-info.outputs.quest_id }}\`
            - **å®Œäº†è€…**: @${{ steps.extract-info.outputs.username }}
            - **é–¢é€£Issue**: #${{ steps.extract-info.outputs.issue_number }}

            ---

            ### ğŸ“ æå‡ºè€…ã¸

            ä»¥ä¸‹ã®æƒ…å ±ã‚’ã“ã®PRã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

            1. **æˆæœç‰©ãƒ»è¨¼æ‹ **
              - é–¢é€£URLï¼ˆè¨˜äº‹ã€ãƒªãƒã‚¸ãƒˆãƒªã€ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆãªã©ï¼‰
              - ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
              - ãã®ä»–ã®æˆæœç‰©

            2. **æŒ¯ã‚Šè¿”ã‚Š**
              - å­¦ã‚“ã ã“ã¨
              - è‹¦åŠ´ã—ãŸã“ã¨
              - æ¬¡ã«æŒ‘æˆ¦ã—ãŸã„ã“ã¨

            ---

            ### âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã¸

            æå‡ºç‰©ã‚’ç¢ºèªã—ã¦ã€æˆåŠŸæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹å ´åˆã¯Approveã—ã¦ãã ã•ã„ã€‚
            å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

            ---

            Closes #${{ steps.extract-info.outputs.issue_number }}`
                        });
                        
                        // PRã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                        await github.rest.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: pullRequest.number,
                          labels: ['quest-completion', 'needs-review']
                        });
                        
                        // å…ƒã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: ${{ steps.extract-info.outputs.issue_number }},
                          body: `ğŸ‰ ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ç”³è«‹ã®PRã‚’ä½œæˆã—ã¾ã—ãŸï¼

            PR: #${pullRequest.number}

            æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
            1. PRã«æˆæœç‰©ï¼ˆURLã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãªã©ï¼‰ã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„
            2. æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜å…¥ã—ã¦ãã ã•ã„
            3. ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ï¼

            é ‘å¼µã‚Šã¾ã—ãŸã­ï¼ğŸ«âœ¨`
            });

            console.log('PR created:', pullRequest.html_url);

      - name: Comment if already completed
        if: steps.update-quest.outputs.updated == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.extract-info.outputs.issue_number }},
              body: `âš ï¸ @${{ steps.extract-info.outputs.username }} ã•ã‚“ã¯æ—¢ã«ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Œäº†ã—ã¦ã„ã¾ã™ã€‚

            å®Œäº†è€…ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š https://github.com/${{ github.repository }}/blob/main/_data/${{ steps.extract-info.outputs.quest_id }}.md`
            });
